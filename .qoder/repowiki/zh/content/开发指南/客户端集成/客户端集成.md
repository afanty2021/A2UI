# 客户端集成

<cite>
**本文档中引用的文件**  
- [config.ts](file://renderers/angular/src/lib/config.ts)
- [public-api.ts](file://renderers/angular/src/public-api.ts)
- [a2a-renderer.ts](file://samples/client/angular/projects/a2a-chat-canvas/src/lib/a2a-renderer/a2a-renderer.ts)
- [a2a-renderer.html](file://samples/client/angular/projects/a2a-chat-canvas/src/lib/a2a-renderer/a2a-renderer.html)
- [tokens.ts](file://samples/client/angular/projects/a2a-chat-canvas/src/lib/a2a-renderer/tokens.ts)
- [signal-model-processor.ts](file://renderers/lit/src/0.8/data/signal-model-processor.ts)
- [core.ts](file://renderers/lit/src/0.8/core.ts)
- [model-processor.ts](file://renderers/lit/src/0.8/data/model-processor.ts)
- [client.ts](file://samples/client/lit/contact/client.ts)
- [app.ts](file://samples/client/lit/shell/app.ts)
- [register-components.ts](file://samples/client/lit/contact/ui/custom-components/register-components.ts)
</cite>

## 目录
1. [简介](#简介)
2. [Angular 集成指南](#angular-集成指南)
3. [Lit 集成指南](#lit-集成指南)
4. [关键概念](#关键概念)
5. [性能优化](#性能优化)
6. [常见问题排查](#常见问题排查)
7. [结论](#结论)

## 简介
A2UI 是一个用于在客户端应用程序中渲染动态用户界面的框架，支持 Angular 和 Lit 等多种前端框架。本指南详细介绍了如何在这两个框架中集成 A2UI 渲染器，涵盖配置、依赖注入、主题处理、WebSocket 连接以及错误处理等核心方面。通过本指南，开发者可以快速上手并实现高效的 A2UI 集成。

## Angular 集成指南

在 Angular 应用程序中集成 A2UI 渲染器需要配置模块、提供依赖并使用专用组件。核心步骤包括通过 `provideA2UI` 提供配置、导入 `A2aRendererModule` 模块以及使用 `a2a-renderer` 组件来渲染动态内容。

### 模块配置与依赖注入
A2UI 的 Angular 渲染器通过环境提供程序（Environment Providers）进行配置。`provideA2UI` 函数接受一个包含目录（catalog）和主题（theme）的配置对象，并使用 Angular 的依赖注入系统将其提供给应用程序。此函数返回一个 `EnvironmentProviders` 对象，可以在应用的根配置中使用。

```typescript
export function provideA2UI(config: { catalog: Catalog; theme: Theme }): EnvironmentProviders {
  return makeEnvironmentProviders([
    { provide: Catalog, useValue: config.catalog },
    { provide: Theme, useValue: config.theme },
  ]);
}
```

**Section sources**
- [config.ts](file://renderers/angular/src/lib/config.ts#L20-L25)

### 使用 a2a-renderer 组件
`a2a-renderer` 是 Angular 中用于渲染 A2UI 内容的核心组件。它通过 `NgComponentOutlet` 动态加载和渲染由变体（variant）标识符指定的组件。该组件接收一个 `uiMessageContent` 输入，其中包含要渲染的数据和变体信息。

组件通过 `RENDERERS_MAP` 注入令牌获取渲染器映射，该映射将变体名称与相应的组件类加载器关联起来。如果找不到指定变体的渲染器，组件会发出警告但不会中断应用。

```typescript
@Component({
  selector: 'a2a-renderer',
  templateUrl: './a2a-renderer.html',
  styleUrl: './a2a-renderer.scss',
  imports: [NgComponentOutlet],
})
export class A2aRenderer {
  readonly uiMessageContent = input.required<UiMessageContent>();
  private readonly renderersMap = inject(RENDERERS_MAP);
  protected readonly componentClassResource = resource({
    loader: async () => {
      const componentClassLoader = this.renderersMap.get(this.uiMessageContent().variant);
      if (!componentClassLoader) {
        console.warn(`No renderer found for variant: ${this.uiMessageContent().variant}`);
        return null;
      }
      return componentClassLoader();
    },
  });
}
```

**Section sources**
- [a2a-renderer.ts](file://samples/client/angular/projects/a2a-chat-canvas/src/lib/a2a-renderer/a2a-renderer.ts#L32-L50)

### 模板与样式
`a2a-renderer` 的模板使用 Angular 的控制流语法 `@if` 来条件性地渲染组件。只有当 `componentClassResource` 具有有效值且组件类存在时，才会通过 `*ngComponentOutlet` 指令实例化目标组件，并将 `uiMessageContent` 作为输入传递。

```html
@if (componentClassResource.hasValue()) {
  @let componentClass = componentClassResource.value();

  @if (componentClass) {
    <ng-container
      *ngComponentOutlet="componentClass; inputs: { uiMessageContent: uiMessageContent() }"
    ></ng-container>
  }
}
```

组件的样式表将宿主元素的显示设置为 `contents`，这意味着它不会在 DOM 中创建额外的包装元素，从而避免了不必要的布局干扰。

**Section sources**
- [a2a-renderer.html](file://samples/client/angular/projects/a2a-chat-canvas/src/lib/a2a-renderer/a2a-renderer.html#L17-L25)
- [a2a-renderer.scss](file://samples/client/angular/projects/a2a-chat-canvas/src/lib/a2a-renderer/a2a-renderer.scss#L15-L17)

### 注入令牌与渲染器映射
`tokens.ts` 文件定义了多个注入令牌，用于在 Angular 的依赖注入系统中注册和解析不同类型的渲染器和解析器。`RENDERERS_MAP` 是一个关键的令牌，它通过工厂函数将 `RENDERERS` 令牌提供的渲染器条目数组转换为一个 `Map`，从而实现基于变体名称的高效查找。

```typescript
export const RENDERERS_MAP = new InjectionToken<ReadonlyMap<string, RendererComponentClassLoader>>(
  'RENDERERS_MAP',
  {
    factory: () => {
      return renderersToMap(inject(RENDERERS));
    },
  },
);
```

**Section sources**
- [tokens.ts](file://samples/client/angular/projects/a2a-chat-canvas/src/lib/a2a-renderer/tokens.ts#L38-L45)

## Lit 集成指南

在 Lit 应用程序中集成 A2UI 渲染器涉及初始化消息处理器、建立与后端的连接以及在 LitElement 中渲染 UI。核心是使用 `createSignalA2uiMessageProcessor` 创建一个响应式数据处理器。

### 初始化消息处理器
Lit 渲染器的核心是 `A2uiMessageProcessor` 类，它负责处理从服务器接收的消息并维护一个结构化的 UI 模型。`createSignalA2uiMessageProcessor` 函数是一个便捷的工厂函数，它创建一个使用信号（Signals）作为底层数据结构的 `A2uiMessageProcessor` 实例，从而实现自动的响应式更新。

```typescript
export function create() {
  return new A2uiMessageProcessor({
    arrayCtor: SignalArray as unknown as ArrayConstructor,
    mapCtor: SignalMap as unknown as MapConstructor,
    objCtor: SignalObject as unknown as ObjectConstructor,
    setCtor: SignalSet as unknown as SetConstructor,
  });
}
```

**Section sources**
- [signal-model-processor.ts](file://renderers/lit/src/0.8/data/signal-model-processor.ts#L24-L31)

### 核心模块导出
`core.ts` 文件是 Lit 渲染器的主要入口点，它重新导出了事件、类型、样式和数据处理等关键模块。它将 `createSignalA2uiMessageProcessor` 函数作为 `Data` 命名空间的一部分导出，方便开发者直接访问。

```typescript
export const Data = {
  createSignalA2uiMessageProcessor,
  A2uiMessageProcessor,
  Guards,
};
```

**Section sources**
- [core.ts](file://renderers/lit/src/0.8/core.ts#L27-L31)

### 处理器功能
`A2uiMessageProcessor` 类实现了 `MessageProcessor` 接口，能够处理多种消息类型，包括 `beginRendering`、`surfaceUpdate`、`dataModelUpdate` 和 `deleteSurface`。它维护一个 `Map` 来存储所有活动的表面（Surface），并提供 `getSurfaces()` 和 `clearSurfaces()` 等方法来访问和管理这些表面。

`processMessages` 方法是处理器的主入口，它遍历消息数组并对每种消息类型调用相应的处理方法。`getData` 和 `setData` 方法允许组件根据数据路径查询和修改模型中的数据，而 `resolvePath` 方法则负责将相对路径解析为绝对路径。

**Section sources**
- [model-processor.ts](file://renderers/lit/src/0.8/data/model-processor.ts#L64-L124)

### WebSocket 与 A2A 服务连接
在 Lit 应用中，通常需要一个客户端类来与后端 A2A 服务通信。`A2UIClient` 类提供了一个 `send` 方法，该方法通过 `fetch` API 向 `/a2a` 端点发送 POST 请求。它处理响应，解析 JSON 数据，并将服务器消息（`ServerToClientMessage`）返回给调用者。该类还包含了错误处理逻辑，能够将网络或服务器错误转换为 JavaScript `Error` 对象。

```typescript
async send(
  message: v0_8.Types.A2UIClientEventMessage
): Promise<v0_8.Types.ServerToClientMessage[]> {
  const response = await fetch("/a2a", {
    body: JSON.stringify(message),
    method: "POST",
  });

  if (response.ok) {
    const data = (await response.json()) as A2AServerPayload;
    // ... 处理成功响应
  }

  const error = (await response.json()) as { error: string };
  throw new Error(error.error);
}
```

**Section sources**
- [client.ts](file://samples/client/lit/contact/client.ts#L39-L63)

### 在 LitElement 中渲染 UI
在 LitElement 组件中，`A2uiMessageProcessor` 的实例通常作为私有属性创建。组件通过监听用户事件（如表单提交）来发送消息，并在收到响应后调用 `processMessages` 方法更新内部模型。

UI 的渲染通常使用 `repeat` 指令来遍历 `getSurfaces()` 返回的表面映射。对于每个表面，都会渲染一个 `<a2ui-surface>` 自定义元素，并将表面数据、处理器实例和表面 ID 作为属性传递。

```typescript
return html`<section id="surfaces">
  ${repeat(
    this.#processor.getSurfaces(),
    ([surfaceId]) => surfaceId,
    ([surfaceId, surface]) => {
      return html`<a2ui-surface
            .surfaceId=${surfaceId}
            .surface=${surface}
            .processor=${this.#processor}
          ></a2ui-surface>`;
    }
  )}
</section>`;
```

**Section sources**
- [app.ts](file://samples/client/lit/shell/app.ts#L448-L506)

## 关键概念

### A2uiConfig
`A2uiConfig` 是一个配置对象，用于在初始化时向 A2UI 渲染器提供必要的设置。它通常包含目录（catalog）和主题（theme）等属性。目录定义了可用的 UI 组件及其行为，而主题则控制了这些组件的视觉外观。

### ClientCapabilities
`ClientCapabilities` 表示客户端支持的功能集。这允许服务器根据客户端的能力调整其响应，例如，发送更高级或更基础的 UI 组件。虽然在提供的代码片段中未直接体现，但这是一个重要的概念，用于实现向后兼容和渐进式增强。

### 增量更新处理
A2UI 协议设计为支持增量更新。`A2uiMessageProcessor` 能够处理 `surfaceUpdate` 和 `dataModelUpdate` 消息，这些消息允许服务器在不重新发送整个 UI 状态的情况下更新特定的表面或数据模型。这极大地提高了性能和响应速度，特别是在网络条件不佳的情况下。

## 性能优化

### 懒加载组件
在 Angular 中，`a2a-renderer` 组件使用 `resource` 函数来实现组件的懒加载。`resource` 是一个异步资源，它只在需要时（即当 `componentClassResource` 被访问时）才加载组件类。这避免了在应用启动时加载所有可能用到的组件，从而减少了初始包的大小和加载时间。

### 内存管理
Lit 渲染器通过使用信号（Signals）实现了高效的内存管理和自动更新。当 `A2uiMessageProcessor` 中的数据模型发生变化时，只有依赖于这些数据的 Lit 组件才会被重新渲染，这避免了不必要的 DOM 操作。此外，`clearSurfaces()` 方法允许在适当时机（如会话结束时）清理所有表面，释放内存。

## 常见问题排查

### 渲染器未找到
如果在控制台中看到 "No renderer found for variant" 的警告，说明 `RENDERERS_MAP` 中缺少对应变体名称的条目。请检查是否已正确注册了该变体的渲染器组件。

### 自定义组件注册
在 Lit 中，可以通过 `componentRegistry.register()` 方法注册自定义组件或覆盖现有组件。例如，`registerContactComponents` 函数注册了一个 `OrgChart` 组件，并用 `PremiumTextField` 覆盖了标准的 `TextField` 组件。

```typescript
componentRegistry.register("TextField", PremiumTextField, "premium-text-field");
```

**Section sources**
- [register-components.ts](file://samples/client/lit/contact/ui/custom-components/register-components.ts#L26-L30)

### 主题注入问题
确保主题对象的结构符合 `Theme` 接口的定义。在 Angular 中，通过 `provideA2UI` 提供的主题会被注入到需要它的组件中。在 Lit 中，主题通常通过上下文（Context）提供，如 `@provide({ context: UI.Context.themeContext })` 所示。

## 结论
本指南详细介绍了在 Angular 和 Lit 框架中集成 A2UI 渲染器的方法。通过理解 `provideA2UI`、`a2a-renderer`、`createSignalA2uiMessageProcessor` 等核心概念和 API，开发者可以有效地将动态 UI 功能集成到他们的应用中。遵循性能优化建议和排查常见问题，可以确保集成的稳定性和高效性。