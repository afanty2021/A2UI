# 消息参考

<cite>
**本文档中引用的文件**   
- [server_to_client.json](file://specification/0.8/json/server_to_client.json)
- [client_to_server.json](file://specification/0.8/json/client_to_server.json)
- [types.ts](file://renderers/lit/src/0.8/types/types.ts)
- [model-processor.ts](file://renderers/lit/src/0.8/data/model-processor.ts)
- [client-event.ts](file://renderers/lit/src/0.8/types/client-event.ts)
- [messages.md](file://docs/reference/messages.md)
</cite>

## 目录
1. [消息类型概览](#消息类型概览)
2. [消息格式与流处理](#消息格式与流处理)
3. [消息类型详细参考](#消息类型详细参考)
   - [beginRendering](#beginrendering)
   - [surfaceUpdate](#surfaceupdate)
   - [dataModelUpdate](#datamodelupdate)
   - [deleteSurface](#deletesurface)
   - [userEvent](#userevent)
4. [更新策略与路径解析](#更新策略与路径解析)
5. [附录：消息示例](#附录消息示例)

## 消息类型概览
A2UI协议定义了一套用于在Agent和Client之间动态构建和更新用户界面的JSON消息。这些消息通过JSON Lines（JSONL）格式进行传输，每行包含一个独立的JSON对象。核心消息类型包括`beginRendering`、`surfaceUpdate`、`dataModelUpdate`和`deleteSurface`，它们均由Agent发送至Client。Client则通过`userEvent`消息向Agent报告用户交互。

**Section sources**
- [messages.md](file://docs/reference/messages.md#L1-L13)

## 消息格式与流处理
所有A2UI消息都遵循一个核心原则：每个消息对象必须且只能包含一个顶级属性，该属性对应一种消息类型。消息以JSONL格式流式传输，允许Agent逐步构建UI，而Client则按顺序处理这些消息以实现增量更新。

**Section sources**
- [messages.md](file://docs/reference/messages.md#L5-L13)

## 消息类型详细参考

### beginRendering
此消息由Agent发送，指示Client可以开始渲染一个UI表面。它标志着UI构建的完成，Client在收到此消息后应将缓冲的组件和数据模型应用到DOM中。

**消息方向**: Agent→Client

| 字段 | 类型 | 是否必需 | 说明 |
| :--- | :--- | :--- | :--- |
| `beginRendering` | object | ✅ | 消息的根对象 |
| `surfaceId` | string | ✅ | UI表面的唯一标识符 |
| `root` | string | ✅ | 作为UI树根节点的组件ID |
| `catalogId` | string | ❌ | 组件目录的标识符。如果省略，则默认使用v0.8标准目录 |
| `styles` | object | ❌ | 与目录定义一致的UI样式信息 |

**JSON Schema**: [server_to_client.json](file://specification/0.8/json/server_to_client.json#L7-L31)

**示例**:
```json
{
  "beginRendering": {
    "surfaceId": "main",
    "root": "root-component"
  }
}
```

**Section sources**
- [server_to_client.json](file://specification/0.8/json/server_to_client.json#L7-L31)
- [messages.md](file://docs/reference/messages.md#L14-L69)

### surfaceUpdate
此消息用于向指定的UI表面添加或更新一组组件。组件以扁平的邻接表形式定义，通过ID相互引用，形成一个树状结构。

**消息方向**: Agent→Client

| 字段 | 类型 | 是否必需 | 说明 |
| :--- | :--- | :--- | :--- |
| `surfaceUpdate` | object | ✅ | 消息的根对象 |
| `surfaceId` | string | ✅ | 要更新的UI表面的ID |
| `components` | array | ✅ | 包含所有UI组件的数组 |

**`components` 数组中的对象**:

| 字段 | 类型 | 是否必需 | 说明 |
| :--- | :--- | :--- | :--- |
| `id` | string | ✅ | 组件的唯一标识符 |
| `weight` | number | ❌ | 组件在其父容器（Row或Column）中的相对权重，对应CSS的`flex-grow`属性 |
| `component` | object | ✅ | 组件定义的包装对象，必须且只能包含一个键，该键为组件类型（如`Text`、`Button`） |

**JSON Schema**: [server_to_client.json](file://specification/0.8/json/server_to_client.json#L32-L69)

**示例**:
```json
{
  "surfaceUpdate": {
    "surfaceId": "main",
    "components": [
      {
        "id": "greeting",
        "component": {
          "Text": {
            "text": {"literalString": "Hello, World!"}
          }
        }
      }
    ]
  }
}
```

**Section sources**
- [server_to_client.json](file://specification/0.8/json/server_to_client.json#L32-L69)
- [messages.md](file://docs/reference/messages.md#L72-L214)

### dataModelUpdate
此消息用于更新与UI表面关联的数据模型。组件通过数据绑定（如`{"path": "/user/name"}`）从数据模型中获取其显示内容。

**消息方向**: Agent→Client

| 字段 | 类型 | 是否必需 | 说明 |
| :--- | :--- | :--- | :--- |
| `dataModelUpdate` | object | ✅ | 消息的根对象 |
| `surfaceId` | string | ✅ | 要更新的数据模型所属的UI表面ID |
| `path` | string | ❌ | 数据模型内的路径（例如`/user/name`）。如果省略或设置为`/`，则替换整个数据模型 |
| `contents` | array | ✅ | 数据条目数组，每个条目包含一个`key`和一个对应的`value*`属性 |

**`contents` 数组中的对象**:

| 字段 | 类型 | 是否必需 | 说明 |
| :--- | :--- | :--- | :--- |
| `key` | string | ✅ | 数据条目的键 |
| `valueString` | string | ❌ | 字符串类型的值 |
| `valueNumber` | number | ❌ | 数字类型的值 |
| `valueBoolean` | boolean | ❌ | 布尔类型的值 |
| `valueMap` | array | ❌ | 一个映射（adjacency list），其元素为包含`key`和`value*`的子对象 |

**JSON Schema**: [server_to_client.json](file://specification/0.8/json/server_to_client.json#L70-L134)

**示例**:
```json
{
  "dataModelUpdate": {
    "surfaceId": "main",
    "path": "user",
    "contents": [
      { "key": "name", "valueString": "Alice" }
    ]
  }
}
```

**Section sources**
- [server_to_client.json](file://specification/0.8/json/server_to_client.json#L70-L134)
- [messages.md](file://docs/reference/messages.md#L217-L300)

### deleteSurface
此消息用于指示Client删除指定的UI表面，包括其所有组件和数据模型。

**消息方向**: Agent→Client

| 字段 | 类型 | 是否必需 | 说明 |
| :--- | :--- | :--- | :--- |
| `deleteSurface` | object | ✅ | 消息的根对象 |
| `surfaceId` | string | ✅ | 要删除的UI表面的ID |

**JSON Schema**: [server_to_client.json](file://specification/0.8/json/server_to_client.json#L135-L146)

**示例**:
```json
{
  "deleteSurface": {
    "surfaceId": "modal"
  }
}
```

**Section sources**
- [server_to_client.json](file://specification/0.8/json/server_to_client.json#L135-L146)
- [messages.md](file://docs/reference/messages.md#L303-L349)

### userEvent
此消息由Client发送，用于向Agent报告用户发起的交互事件，例如按钮点击。

**消息方向**: Client→Agent

| 字段 | 类型 | 是否必需 | 说明 |
| :--- | :--- | :--- | :--- |
| `userAction` | object | ✅ | 事件的根对象 |
| `name` | string | ✅ | 事件的名称，取自组件的`action.name`属性 |
| `surfaceId` | string | ✅ | 事件源所在的表面ID |
| `sourceComponentId` | string | ✅ | 触发事件的组件ID |
| `timestamp` | string | ✅ | 事件发生的ISO 8601时间戳 |
| `context` | object | ❌ | 一个JSON对象，包含组件`action.context`中的键值对，在解析所有数据绑定后 |

**JSON Schema**: [client_to_server.json](file://specification/0.8/json/client_to_server.json#L8-L41)

**示例**:
```json
{
  "userAction": {
    "name": "submit",
    "surfaceId": "form",
    "sourceComponentId": "submit-btn",
    "timestamp": "2025-04-05T12:00:00Z",
    "context": {
      "userId": "123"
    }
  }
}
```

**Section sources**
- [client_to_server.json](file://specification/0.8/json/client_to_server.json#L8-L41)
- [client-event.ts](file://renderers/lit/src/0.8/types/client-event.ts#L48-L72)

## 更新策略与路径解析

### surfaceUpdate 中的 componentTree 和 dataModel 更新策略
当Client收到`surfaceUpdate`消息时，其内部的消息处理器（`A2uiMessageProcessor`）会执行以下操作：
1.  **更新组件映射**：将`components`数组中的每个组件实例（`ComponentInstance`）存储在一个以`id`为键的`Map`中（`surface.components`）。
2.  **重建组件树**：调用`#rebuildComponentTree`方法，从`beginRendering`消息中指定的`root`组件ID开始，递归地构建一个完整的、解析后的组件树（`componentTree`）。这个过程会解析所有属性，包括将ID引用转换为实际的子节点。
3.  **触发渲染**：一旦`componentTree`被重建，Client的UI框架（如Lit）会使用这个树来更新DOM。

`dataModelUpdate`的处理逻辑类似：
1.  **定位数据模型**：根据`surfaceId`找到对应的`surface.dataModel`（一个`Map<string, DataValue>`）。
2.  **应用更新**：调用`#setDataByPath`方法，根据`path`字段将`contents`中的数据应用到数据模型的指定位置。如果`path`为空，则替换整个数据模型。
3.  **重建组件树**：数据模型的更新会触发`#rebuildComponentTree`，因为组件的属性可能依赖于数据模型中的值（通过数据绑定）。

**Section sources**
- [model-processor.ts](file://renderers/lit/src/0.8/data/model-processor.ts#L97-L123)
- [model-processor.ts](file://renderers/lit/src/0.8/data/model-processor.ts#L426-L434)

### userEvent 中 jsonPointer 的路径解析规则
在A2UI协议中，`jsonPointer`的概念主要体现在`dataModelUpdate`消息的`path`字段和组件属性中的`{"path": "..."}`绑定上。其解析规则如下：
1.  **绝对路径**：以`/`开头的路径（如`/user/name`）是绝对路径，它直接指向数据模型的根节点下的指定位置。
2.  **相对路径**：不以`/`开头的路径（如`name`）是相对路径。它的解析依赖于组件的`dataContextPath`。
3.  **上下文路径（dataContextPath）**：每个组件节点在解析后的树中都有一个`dataContextPath`属性，它定义了该组件解析相对路径时的“工作目录”。
4.  **路径解析**：当需要解析一个相对路径时，系统会将其与组件的`dataContextPath`进行拼接。例如，如果`dataContextPath`是`/user/123`，而相对路径是`name`，则最终的解析路径为`/user/123/name`。
5.  **特殊路径 `.`**：路径`.`是一个特殊符号，表示“当前节点的数据上下文”。例如，一个`TextField`组件的`text`属性设置为`{"path": "."}`，意味着它将显示其`dataContextPath`所指向的整个数据对象。

**Section sources**
- [model-processor.ts](file://renderers/lit/src/0.8/data/model-processor.ts#L181-L196)
- [model-processor.ts](file://renderers/lit/src/0.8/data/model-processor.ts#L827-L837)

## 附录：消息示例
以下是一个完整的JSONL消息流示例，展示了如何创建一个联系人表单：

```jsonl
{"surfaceUpdate": {"surfaceId": "contact_form", "components": [{"id": "root", "component": {"Column": {"children": {"explicitList": ["name_field", "email_field", "submit_btn"]}}}}, {"id": "name_field", "component": {"TextField": {"label": "Name", "text": {"path": "/contact/name"}}}}, {"id": "email_field", "component": {"TextField": {"label": "Email", "text": {"path": "/contact/email"}}}}, {"id": "submit_btn", "component": {"Button": {"child": "submit_label", "action": {"name": "submitForm", "context": {"formId": "contact_form"}}}}}, {"id": "submit_label", "component": {"Text": {"text": {"literalString": "Submit"}}}}]}}
{"dataModelUpdate": {"surfaceId": "contact_form", "contents": [{"key": "contact", "valueMap": [{"key": "name", "valueString": ""}, {"key": "email", "valueString": ""}]}]}}
{"beginRendering": {"surfaceId": "contact_form", "root": "root"}}
```