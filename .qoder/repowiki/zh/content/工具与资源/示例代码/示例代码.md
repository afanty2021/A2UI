# 示例代码

<cite>
**本文档中引用的文件**  
- [agent.py](file://samples/agent/adk/contact_lookup/agent.py)
- [a2ui_examples.py](file://samples/agent/adk/contact_lookup/a2ui_examples.py)
- [prompt_builder.py](file://samples/agent/adk/contact_lookup/prompt_builder.py)
- [tools.py](file://samples/agent/adk/contact_lookup/tools.py)
- [agent.py](file://samples/agent/adk/orchestrator/agent.py)
- [agent.py](file://samples/agent/adk/rizzcharts/agent.py)
- [app.ts](file://samples/client/angular/projects/gallery/src/app/app.ts)
- [gallery.component.ts](file://samples/client/angular/projects/gallery/src/app/features/gallery/gallery.component.ts)
- [app.ts](file://samples/client/angular/projects/contact/src/app/app.ts)
- [app.ts](file://samples/client/angular/projects/orchestrator/src/app/app.ts)
- [client.ts](file://samples/client/lit/contact/client.ts)
- [register-components.ts](file://samples/client/lit/contact/ui/custom-components/register-components.ts)
- [README.md](file://samples/agent/adk/contact_lookup/README.md)
- [README.md](file://samples/agent/adk/orchestrator/README.md)
- [README.md](file://samples/agent/adk/rizzcharts/README.md)
- [pyproject.toml](file://samples/agent/adk/contact_lookup/pyproject.toml)
- [package.json](file://samples/client/lit/contact/package.json)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [Agent端示例](#agent端示例)
   1. [contact_lookup](#contact_lookup)
   2. [orchestrator](#orchestrator)
   3. [rizzcharts](#rizzcharts)
4. [客户端示例](#客户端示例)
   1. [Angular框架示例](#angular框架示例)
   2. [Lit框架示例](#lit框架示例)
5. [运行指令](#运行指令)
6. [最佳实践](#最佳实践)
7. [结论](#结论)

## 简介
本文档旨在系统性地引导开发者浏览`samples/`目录下的完整集成示例。文档将详细解析Agent端和客户端的各个示例，涵盖从基础数据查询到复杂多代理协作的实现方式。通过分析具体的业务逻辑、A2UI JSON生成方法以及对应的实现代码，为开发者提供清晰的开发指导和最佳实践。

## 项目结构
`samples/`目录是本项目的核心示例集合，分为`agent/`和`client/`两大分支。`agent/`目录包含基于Agent Development Kit (ADK)构建的各类Agent示例，如`contact_lookup`、`orchestrator`和`rizzcharts`。`client/`目录则包含使用不同前端框架（如Angular和Lit）构建的客户端应用，用于渲染和交互Agent生成的UI。每个示例都包含完整的配置文件（如`pyproject.toml`和`package.json`）、实现代码和详细的`README.md`说明。

## Agent端示例

### contact_lookup
`contact_lookup`示例展示了如何实现一个基础的数据查询与表单生成Agent。该Agent的核心功能是根据用户查询查找联系人信息，并生成相应的UI界面。

**业务逻辑**：Agent通过`get_contact_info`工具函数查询`contact_data.json`文件中的联系人数据。根据查询结果，Agent会动态选择不同的UI模板：当找到单个联系人时，使用`CONTACT_CARD_EXAMPLE`模板显示详细信息；当找到多个联系人时，使用`CONTACT_LIST_EXAMPLE`模板以列表形式展示；当未找到联系人时，则返回空的JSON列表。

**A2UI JSON生成**：A2UI JSON的生成由`prompt_builder.py`中的`get_ui_prompt`函数驱动。该函数构建了一个包含详细规则和示例的系统提示，指导LLM生成符合A2UI规范的JSON响应。响应必须包含`---a2ui_JSON---`分隔符，其后是经过`A2UI_SCHEMA`验证的JSON数组。

**实现代码**：在`agent.py`文件中，`ContactAgent`类的`stream`方法实现了核心逻辑。它首先调用LLM生成响应，然后通过`jsonschema.validate`对响应中的JSON部分进行严格验证。如果验证失败，会进行重试，确保最终输出的UI定义是有效的。

**Section sources**
- [agent.py](file://samples/agent/adk/contact_lookup/agent.py#L1-L293)
- [a2ui_examples.py](file://samples/agent/adk/contact_lookup/a2ui_examples.py#L1-L163)
- [prompt_builder.py](file://samples/agent/adk/contact_lookup/prompt_builder.py#L1-L119)
- [tools.py](file://samples/agent/adk/contact_lookup/tools.py#L1-L69)

### orchestrator
`orchestrator`示例展示了复杂的多代理协作模式，即一个主Agent如何将任务路由到多个专家子Agent。

**业务逻辑**：`OrchestratorAgent`本身不直接处理用户请求，而是作为一个“调度员”。它接收用户请求，分析用户意图，并将任务精确地路由到最合适的子Agent（如`contact_lookup`或`restaurant_finder`）。这种模式实现了职责分离和功能专业化。

**A2UI JSON生成**：与`contact_lookup`不同，`orchestrator`本身不生成复杂的A2UI JSON。它通过`RemoteA2aAgent`与子Agent通信，并将子Agent生成的A2UI消息透明地传递给客户端。关键在于`A2UIMetadataInterceptor`，它在向子Agent发送请求时，会注入A2UI扩展头和客户端能力信息，确保子Agent能生成兼容的UI。

**实现代码**：`agent.py`文件中的`build_agent`方法是核心。它动态地从`subagent_urls`配置的地址获取各个子Agent的`AgentCard`，并为每个子Agent创建一个`RemoteA2aAgent`实例。`programmtically_route_user_action_to_subagent`方法则实现了对用户操作（如按钮点击）的程序化路由，提升了响应效率。

**Section sources**
- [agent.py](file://samples/agent/adk/orchestrator/agent.py#L1-L189)
- [README.md](file://samples/agent/adk/orchestrator/README.md#L1-L65)

### rizzcharts
`rizzcharts`示例展示了如何创建自定义组件与图表渲染，实现一个电商数据仪表盘。

**业务逻辑**：该Agent专门处理与销售数据相关的查询。它能根据用户请求（如“显示Q3销售数据”）判断是生成图表（Chart）还是地图（Map），然后调用相应的工具（`get_sales_data`或`get_store_sales`）获取数据，并填充到预定义的JSON模板中。

**A2UI JSON生成**：`rizzcharts`使用了自定义组件目录（`rizzcharts_catalog_definition.json`）。其`get_instructions`方法会根据客户端请求的目录（标准目录或自定义目录）加载不同的JSON示例（`chart.json`或`map.json`）。生成的A2UI JSON必须包含一个唯一的`surfaceId`，并更新模板中的标题文本以匹配用户查询。

**实现代码**：`agent.py`文件中的`get_a2ui_schema`和`load_example`方法负责加载和验证A2UI模式与示例。`build_agent`方法将`A2uiToolset`作为工具注入，该工具集提供了`send_a2ui_json_to_client`功能，用于向客户端发送构造好的A2UI JSON。

**Section sources**
- [agent.py](file://samples/agent/adk/rizzcharts/agent.py#L1-L153)
- [README.md](file://samples/agent/adk/rizzcharts/README.md#L1-L40)

## 客户端示例

### Angular框架示例
Angular客户端示例展示了如何在成熟的框架中集成A2UI渲染器。

**gallery项目**：`gallery`项目是一个组件展示应用。`GalleryComponent`通过`samples`数组预定义了多个A2UI `Surface`对象（如列表、表单、欢迎卡片）。它使用`@ViewChild`和`HTMLDialogElement`来控制模态框的显示，允许用户点击预览。`getJson`方法将`Surface`对象序列化为格式化的JSON字符串，便于开发者查看和学习。

**contact项目**：`contact`项目演示了简单的交互。`App`组件通过`inject(Client)`获取客户端服务实例。`handleSubmit`方法拦截表单提交事件，将用户输入作为`A2UIClientEventMessage`发送给后端Agent，并通过`hasData`信号量更新UI状态，指示已有数据返回。

**orchestrator项目**：`orchestrator`项目处理复杂的状态管理。它通过`Renderer2`在`ngOnInit`生命周期中动态加载Google Maps API脚本，为地图组件提供支持。`A2aChatCanvas`组件被用作核心渲染器，并通过`demoMessageDecorator`进行消息装饰，实现了高级的UI集成。

**Section sources**
- [app.ts](file://samples/client/angular/projects/gallery/src/app/app.ts#L1-L34)
- [gallery.component.ts](file://samples/client/angular/projects/gallery/src/app/features/gallery/gallery.component.ts#L1-L247)
- [app.ts](file://samples/client/angular/projects/contact/src/app/app.ts#L1-L51)
- [app.ts](file://samples/client/angular/projects/orchestrator/src/app/app.ts#L1-L46)

### Lit框架示例
Lit客户端示例展示了轻量级Web组件框架的集成方式。

**contact项目**：`contact`项目的核心是`client.ts`和`register-components.ts`。`A2UIClient`类封装了与后端Agent的通信逻辑，通过`fetch` API发送`POST`请求并处理响应。`registerContactComponents`函数则展示了自定义组件的注册机制，它使用`componentRegistry`将`OrgChart`和`PremiumTextField`组件注册到全局，其中`PremiumTextField`作为`TextField`的覆盖组件，实现了组件的扩展和定制。

**Section sources**
- [client.ts](file://samples/client/lit/contact/client.ts#L1-L66)
- [register-components.ts](file://samples/client/lit/contact/ui/custom-components/register-components.ts#L1-L34)

## 运行指令
要运行这些示例，请遵循以下通用步骤：

1.  **环境准备**：确保已安装Python 3.9+、Node.js以及`uv`包管理器。
2.  **设置API密钥**：在每个Agent示例目录下创建`.env`文件，并设置`GEMINI_API_KEY`。
3.  **安装依赖**：对于Agent，使用`uv sync`；对于客户端，使用`npm install`。
4.  **启动服务**：
    *   **contact_lookup**：在`samples/agent/adk/contact_lookup`目录下运行`uv run .`。
    *   **orchestrator**：首先启动所有子Agent（`restaurant_finder`, `contact_lookup`, `rizzcharts`），然后在`samples/agent/adk/orchestrator`目录下运行`uv run . --subagent_urls=http://localhost:10003 --subagent_urls=http://localhost:10004 --subagent_urls=http://localhost:10005`。
    *   **rizzcharts**：在`samples/agent/adk/rizzcharts`目录下运行`uv run .`。
5.  **启动客户端**：进入相应的客户端目录（如`samples/client/angular/projects/contact`），运行`npm run dev`启动开发服务器。

**Section sources**
- [README.md](file://samples/agent/adk/contact_lookup/README.md#L1-L40)
- [README.md](file://samples/agent/adk/orchestrator/README.md#L1-L65)
- [README.md](file://samples/agent/adk/rizzcharts/README.md#L1-L40)
- [pyproject.toml](file://samples/agent/adk/contact_lookup/pyproject.toml#L1-L27)
- [package.json](file://samples/client/lit/contact/package.json#L1-L85)

## 最佳实践
*   **明确的提示工程**：如`prompt_builder.py`所示，为LLM提供清晰、结构化的提示（包含规则、示例和模式）是生成有效A2UI JSON的关键。
*   **严格的验证**：`contact_lookup`中的`stream`方法展示了在生产环境中必须对LLM生成的JSON进行验证，以防止无效或恶意的UI定义。
*   **模块化与复用**：`a2ui_examples.py`将UI模板集中管理，便于复用和维护。
*   **安全第一**：所有示例的`README.md`都强调了安全警告，提醒开发者必须将外部Agent的数据视为不可信输入，并实施适当的验证和沙箱机制。
*   **灵活的客户端集成**：无论是Angular的依赖注入还是Lit的组件注册，都展示了A2UI渲染器可以灵活地集成到不同的前端技术栈中。

## 结论
通过对`samples/`目录下示例的系统性分析，我们可以看到A2UI架构的强大和灵活性。从简单的`contact_lookup`到复杂的`orchestrator`，再到具有自定义组件的`rizzcharts`，这些示例共同构成了一个完整的开发指南。开发者可以借鉴这些模式，结合Angular或Lit等前端框架，构建出功能丰富、交互性强的智能应用。