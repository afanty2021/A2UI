# 协议规范

<cite>
**本文档中引用的文件**  
- [standard_catalog_definition.json](file://specification/0.8/json/standard_catalog_definition.json)
- [server_to_client.json](file://specification/0.8/json/server_to_client.json)
- [client_to_server.json](file://specification/0.8/json/client_to_server.json)
- [server_to_client_with_standard_catalog.json](file://specification/0.8/json/server_to_client_with_standard_catalog.json)
- [standard_catalog_definition.json](file://specification/0.9/json/standard_catalog_definition.json)
- [server_to_client.json](file://specification/0.9/json/server_to_client.json)
- [client_to_server.json](file://specification/0.9/json/client_to_server.json)
- [common_types.json](file://specification/0.9/json/common_types.json)
- [contact_form_example.jsonl](file://specification/0.9/json/contact_form_example.jsonl)
- [evolution_guide.md](file://specification/0.9/docs/evolution_guide.md)
- [v0.8-a2ui.md](file://docs/specification/v0.8-a2ui.md)
- [v0.9-a2ui.md](file://docs/specification/v0.9-a2ui.md)
- [standard_catalog_rules.txt](file://specification/0.9/json/standard_catalog_rules.txt)
</cite>

## 目录
1. [引言](#引言)
2. [v0.8 稳定版协议](#v08-稳定版协议)
3. [v0.9 草案版协议](#v09-草案版协议)
4. [版本演进与差异](#版本演进与差异)
5. [消息序列化与传输](#消息序列化与传输)
6. [组件目录协商机制](#组件目录协商机制)

## 引言

A2UI（Agent to UI）协议是一种用于动态构建和更新用户界面的通信协议。本技术规范文档旨在为开发者提供一个权威的参考，以构建兼容的Agent（代理）或渲染器（Renderer）。文档将明确区分v0.8（稳定版）和v0.9（草案版）两个版本，详细定义每个版本的消息类型、JSON Schema、序列化格式和传输要求。

**Section sources**
- [v0.8-a2ui.md](file://docs/specification/v0.8-a2ui.md)
- [v0.9-a2ui.md](file://docs/specification/v0.9-a2ui.md)

## v0.8 稳定版协议

v0.8是当前的稳定版本，推荐用于生产环境。该版本的协议设计侧重于通过大型语言模型（LLM）的结构化输出功能来生成。

### 消息类型定义 (JSON Schema)

在v0.8中，服务器到客户端的消息（`server_to_client.json`）是一个包含四个互斥操作的对象。一个消息必须且只能包含以下一个操作属性。

**Section sources**
- [server_to_client.json](file://specification/0.8/json/server_to_client.json)
- [server_to_client_with_standard_catalog.json](file://specification/0.8/json/server_to_client_with_standard_catalog.json)

#### `beginRendering`

此消息通知客户端开始渲染一个新界面。

```json
{
  "beginRendering": {
    "surfaceId": "string",
    "root": "string",
    "styles": {
      "font": "string",
      "primaryColor": "#RRGGBB"
    }
  }
}
```

- **`surfaceId`**: 字符串类型，必填。界面的唯一标识符。
- **`root`**: 字符串类型，必填。根组件的ID。
- **`styles`**: 对象类型，可选。包含`font`（字体）和`primaryColor`（主色调）的样式信息。

**Section sources**
- [server_to_client.json](file://specification/0.8/json/server_to_client.json#L7-L38)

#### `surfaceUpdate`

此消息更新一个界面的组件树。

```json
{
  "surfaceUpdate": {
    "surfaceId": "string",
    "components": [
      {
        "id": "string",
        "weight": 1.0,
        "component": {
          "Text": {
            "text": { "literalString": "Hello" },
            "usageHint": "body"
          }
        }
      }
    ]
  }
}
```

- **`surfaceId`**: 字符串类型，必填。要更新的界面的唯一标识符。
- **`components`**: 数组类型，必填。包含所有UI组件的列表。
  - **`id`**: 字符串类型，必填。组件的唯一标识符。
  - **`weight`**: 数字类型，可选。在`Row`或`Column`中的相对权重。
  - **`component`**: 对象类型，必填。一个包装对象，其键为组件类型（如`Text`），值为该组件的具体属性。

**Section sources**
- [server_to_client.json](file://specification/0.8/json/server_to_client.json#L32-L69)

#### `dataModelUpdate`

此消息更新一个界面的数据模型。

```json
{
  "dataModelUpdate": {
    "surfaceId": "string",
    "path": "/user/name",
    "contents": [
      {
        "key": "name",
        "valueString": "Alice"
      },
      {
        "key": "age",
        "valueNumber": 30
      }
    ]
  }
}
```

- **`surfaceId`**: 字符串类型，必填。要更新的数据模型所属的界面ID。
- **`path`**: 字符串类型，可选。数据模型内的路径（JSON Pointer）。
- **`contents`**: 数组类型，必填。包含数据条目的数组，每个条目有`key`和一个`value*`属性（如`valueString`, `valueNumber`）。

**Section sources**
- [server_to_client.json](file://specification/0.8/json/server_to_client.json#L70-L134)

#### `deleteSurface`

此消息通知客户端删除一个界面。

```json
{
  "deleteSurface": {
    "surfaceId": "string"
  }
}
```

- **`surfaceId`**: 字符串类型，必填。要删除的界面的唯一标识符。

**Section sources**
- [server_to_client.json](file://specification/0.8/json/server_to_client.json#L135-L147)

### 组件目录 (Catalog)

v0.8的组件目录定义在`standard_catalog_definition.json`中。它是一个包含`components`和`styles`对象的JSON Schema。

- **`components`**: 一个对象，其键为组件名称（如`Text`, `Image`），值为该组件的详细Schema。
- **`styles`**: 一个对象，定义了可应用的全局样式，如`font`和`primaryColor`。

例如，`Text`组件的Schema定义了`text`（可以是`literalString`或`path`）和`usageHint`（如`h1`, `body`）等属性。

**Section sources**
- [standard_catalog_definition.json](file://specification/0.8/json/standard_catalog_definition.json)

## v0.9 草案版协议

v0.9是当前的草案版本，引入了重大的架构和哲学变革，旨在更好地适应LLM的提示（Prompt）生成模式。

### 消息类型定义 (JSON Schema)

v0.9的协议设计为“提示优先”（Prompt First），其Schema更扁平化，更易于LLM理解和生成。

**Section sources**
- [server_to_client.json](file://specification/0.9/json/server_to_client.json)

#### `createSurface`

此消息取代了v0.8的`beginRendering`，用于创建一个新界面。

```json
{
  "createSurface": {
    "surfaceId": "string",
    "catalogId": "string"
  }
}
```

- **`surfaceId`**: 字符串类型，必填。界面的唯一标识符。
- **`catalogId`**: 字符串类型，必填。所使用的组件目录的唯一标识符（通常是一个URI）。

**重要变化**: 此消息不再包含`styles`或`root`。根组件通过ID为`root`的组件来指定。

**Section sources**
- [server_to_client.json](file://specification/0.9/json/server_to_client.json#L14-L36)

#### `updateComponents`

此消息取代了v0.8的`surfaceUpdate`，用于更新组件树。

```json
{
  "updateComponents": {
    "surfaceId": "string",
    "components": [
      {
        "id": "root",
        "component": "Column",
        "children": ["title"]
      },
      {
        "id": "title",
        "component": "Text",
        "text": "Hello"
      }
    ]
  }
}
```

- **`surfaceId`**: 字符串类型，必填。要更新的界面的唯一标识符。
- **`components`**: 数组类型，必填。包含所有UI组件的列表。
  - **`id`**: 字符串类型，必填。组件的唯一标识符。
  - **`component`**: 字符串类型，必填。组件的类型（如`Text`, `Button`），作为类型判别器。
  - 其他属性（如`text`, `url`）直接作为该对象的属性，不再嵌套在`component`对象内。

**重要变化**: 结构从嵌套的`{"component": {"Text": {...}}}`变为扁平的`{"component": "Text", ...}`。

**Section sources**
- [server_to_client.json](file://specification/0.9/json/server_to_client.json#L37-L63)

#### `updateDataModel`

此消息取代了v0.8的`dataModelUpdate`，用于更新数据模型。

```json
{
  "updateDataModel": {
    "surfaceId": "string",
    "path": "/user/name",
    "op": "replace",
    "value": {
      "name": "Alice",
      "age": 30
    }
  }
}
```

- **`surfaceId`**: 字符串类型，必填。要更新的数据模型所属的界面ID。
- **`path`**: 字符串类型，可选。数据模型内的路径。
- **`op`**: 字符串类型，可选。操作类型，可以是`add`, `replace`（默认）, `remove`。
- **`value`**: 任意类型，必填（当`op`不为`remove`时）。要更新的数据，直接使用标准的JSON对象。

**重要变化**: 从“邻接列表”数组变为标准的JSON对象，更符合LLM的生成习惯。

**Section sources**
- [server_to_client.json](file://specification/0.9/json/server_to_client.json#L64-L94)

#### `deleteSurface`

此消息的语义与v0.8相同，但其结构被重新定义以符合v0.9的模式。

```json
{
  "deleteSurface": {
    "surfaceId": "string"
  }
}
```

- **`surfaceId`**: 字符串类型，必填。要删除的界面的唯一标识符。

**Section sources**
- [server_to_client.json](file://specification/0.9/json/server_to_client.json#L95-L112)

### 组件目录 (Catalog)

v0.9的组件目录（`standard_catalog_definition.json`）采用了模块化和更现代的JSON Schema设计。

**Section sources**
- [standard_catalog_definition.json](file://specification/0.9/json/standard_catalog_definition.json)
- [common_types.json](file://specification/0.9/json/common_types.json)

#### 核心变化

1.  **模块化**: 使用`$defs`定义了可重用的类型，如`ComponentCommon`（包含`id`和`weight`）和`stringOrPath`。
2.  **类型判别器**: 使用`discriminator`关键字和`component`属性来实现组件的多态性。
3.  **统一的数据绑定**: 所有需要绑定到数据模型的值都使用`path`属性，取代了v0.8中不一致的`dataBinding`和`path`。
4.  **组件重命名与简化**:
    -   `MultipleChoice` 组件被 `ChoicePicker` 取代，并通过 `usageHint` 属性（`multipleSelection` 或 `mutuallyExclusive`）来控制行为。
    -   `TextField` 的 `textFieldType` 属性被 `usageHint` 取代，以保持与其他组件的一致性。
    -   `Slider` 的 `minValue` 和 `maxValue` 被简化为 `min` 和 `max`。

#### 辅助规则文件

v0.9引入了`standard_catalog_rules.txt`文件，这是一个纯文本规则集，旨在与Schema一起嵌入到LLM的系统提示中。它用自然语言描述了Schema难以表达的约束，例如“Button组件必须提供action属性”。

**Section sources**
- [standard_catalog_rules.txt](file://specification/0.9/json/standard_catalog_rules.txt)

## 版本演进与差异

本节总结了从v0.8到v0.9的关键演进。

**Section sources**
- [evolution_guide.md](file://specification/0.9/docs/evolution_guide.md)

### 核心哲学转变

- **v0.8**: **结构化输出优先**。设计目标是让LLM通过函数调用或严格JSON模式生成。
- **v0.9**: **提示优先**。设计目标是让Schema和规则直接作为LLM提示的一部分，利用LLM对标准JSON的天然理解能力。

### 关键差异对比

| 特性 | v0.8 (稳定版) | v0.9 (草案版) |
| :--- | :--- | :--- |
| **哲学** | 结构化输出 / 函数调用 | 提示优先 / 上下文内Schema |
| **消息类型** | `beginRendering`, `surfaceUpdate`, `dataModelUpdate`, `deleteSurface` | `createSurface`, `updateComponents`, `updateDataModel`, `deleteSurface` |
| **表面创建** | `beginRendering` 包含 `root` 和 `styles` | `createSurface` 仅包含 `catalogId`，`root` 通过组件ID指定 |
| **组件类型** | 通过对象的**键**（如`{"Text": ...}`） | 通过 `component` **属性**（如`"component": "Text"`） |
| **数据模型更新** | 数组形式的键值对（邻接列表） | 标准JSON对象 |
| **数据绑定** | `dataBinding` / `literalString` 等 | `path` / 原生JSON类型 |
| **按钮上下文** | 键值对数组 | 标准JSON对象 |
| **辅助规则** | 无 | `standard_catalog_rules.txt` |

## 消息序列化与传输

A2UI协议的消息使用JSON格式进行序列化。为了支持流式传输，消息通常以**JSONL**（JSON Lines）格式进行传输。

**JSONL**是一种文本格式，其中每一行都是一个独立的、有效的JSON对象。这种格式允许发送方逐行发送消息，接收方可以逐行解析，非常适合实时流式通信。

例如，一个包含多个操作的会话可能如下所示：
```
{"createSurface":{"surfaceId":"form","catalogId":"https://a2ui.dev/specification/0.9/standard_catalog_definition.json"}}
{"updateComponents":{"surfaceId":"form","components":[...]}}
{"updateDataModel":{"surfaceId":"form","value":{"name":"John"}}}
```

**Section sources**
- [contact_form_example.jsonl](file://specification/0.9/json/contact_form_example.jsonl)

## 组件目录协商机制

为了实现客户端和服务器之间的互操作性，A2UI协议支持组件目录的协商。

1.  **客户端声明能力**: 客户端通过发送`clientUiCapabilities`消息（在`client_to_server.json`中定义）来告知服务器它支持哪些组件目录（通过`catalogId`标识）。
2.  **服务器选择目录**: 服务器在收到客户端的能力声明后，可以选择一个双方都支持的目录。
3.  **创建表面时指定**: 服务器在发送`createSurface`（v0.9）或`beginRendering`（v0.8）消息时，必须明确指定所使用的`catalogId`。
4.  **渲染器解析**: 客户端渲染器根据收到的`catalogId`加载对应的组件目录Schema，并据此解析和渲染后续的`updateComponents`消息。

这种机制允许客户端支持自定义组件集，并确保服务器只发送客户端能够理解的组件。

**Section sources**
- [client_to_server.json](file://specification/0.8/json/client_to_server.json)
- [client_to_server.json](file://specification/0.9/json/client_to_server.json)