# v0.9演进指南

<cite>
**本文档中引用的文件**   
- [v0.9-evolution-guide.md](file://docs/specification/v0.9-evolution-guide.md)
- [v0.9-a2ui.md](file://docs/specification/v0.9-a2ui.md)
- [v0.8-a2ui.md](file://docs/specification/v0.8-a2ui.md)
- [evolution_guide.md](file://specification/0.9/docs/evolution_guide.md)
- [a2ui_protocol.md](file://specification/0.9/docs/a2ui_protocol.md)
- [a2ui_protocol.md](file://specification/0.8/docs/a2ui_protocol.md)
- [server_to_client.json](file://specification/0.9/json/server_to_client.json)
- [standard_catalog_definition.json](file://specification/0.9/json/standard_catalog_definition.json)
- [a2ui_schema.py](file://samples/agent/adk/contact_lookup/a2ui_schema.py)
- [agent.py](file://samples/agent/adk/contact_lookup/agent.py)
</cite>

## 目录
1. [简介](#简介)
2. [核心变更概览](#核心变更概览)
3. [架构与协议变更](#架构与协议变更)
4. [消息结构变更](#消息结构变更)
5. [数据绑定与状态管理](#数据绑定与状态管理)
6. [组件变更](#组件变更)
7. [错误处理](#错误处理)
8. [迁移检查清单](#迁移检查清单)
9. [设计动机与未来方向](#设计动机与未来方向)

## 简介

本指南旨在帮助开发者从A2UI v0.8平滑迁移到v0.9。v0.9版本代表了从“结构化输出优先”到“提示优先”（Prompt-First）的根本性哲学转变。v0.8的设计目标是让LLM通过结构化输出（如JSON模式或函数调用）生成，而v0.9的设计目标是将协议直接嵌入LLM的系统提示中，让LLM在上下文中生成符合模式的JSON。

**v0.8.1**：为结构化输出优化，依赖深度嵌套和特定的包装结构。
**v0.9**：为提示优先优化，重构了模式以提高人类可读性和LLM生成效率。

## 核心变更概览

v0.9版本引入了多项破坏性变更和新功能，主要集中在架构、消息结构、数据绑定和组件设计上。

### 变更摘要表

| 特性 | v0.8.1 | v0.9 |
| :--- | :--- | :--- |
| **哲学** | 结构化输出 / 函数调用 | 提示优先 / 上下文模式 |
| **消息类型** | `beginRendering`, `surfaceUpdate`, ... | `createSurface`, `updateComponents`, ... |
| **表面创建** | 显式 `beginRendering` | 显式 `createSurface` |
| **组件类型** | 基于键的包装 (`{"Text": ...}`) | 基于属性的判别符 (`"component": "Text"`) |
| **数据模型更新** | 键值对数组 | 标准JSON对象 |
| **数据绑定** | `dataBinding` / `literalString` | `path` / 原生JSON类型 |
| **按钮上下文** | 键值对数组 | 标准JSON对象 |
| **辅助规则** | 无 | `standard_catalog_rules.txt` |
| **验证** | 基本模式 | 严格的 `ValidationFailed` 反馈循环 |

## 架构与协议变更

### 2.1. 模块化模式架构

**v0.8.1**：
- 倾向于单体架构。`server_to_client.json` 通常包含深度定义或复杂的 `oneOf` 结构，难以分解。
- `standard_catalog_definition.json` 存在但通常隐式耦合。

**v0.9**：
- **模块化**：模式被严格拆分为：
  - `common_types.json`：可重用的基元（ID、路径、权重）。
  - `server_to_client.json`：定义消息类型的“信封”。
  - `standard_catalog_definition.json`：特定的UI组件。
- **优势**：允许开发者在不修改核心协议解析器的情况下，用 `custom_catalog.json` 替换 `standard_catalog_definition.json`。

### 2.2. 严格的消息类型

**v0.8.1**：
- 消息是对象，其中 `surfaceUpdate` 等属性是可选键。
- 验证通常依赖于 "minProperties: 1" 约束。

**v0.9**：
- 在 `server_to_client.json` 中使用顶级 **`oneOf`** 约束。
- **原因**：这是向LLM表达模式的更自然方式，也更容易让LLM推理。对开发者来说，阅读起来也更自然。

### 2.3. 辅助规则文件

**v0.9**：
- **新工件**：`standard_catalog_rules.txt`。
- **目的**：一个纯文本的提示片段，包含使用目录模式的规则（例如，“按钮必须提供 'action'”）。
- **用法**：设计为与目录模式一起包含在系统提示中。
- **原因**：某些约束（如条件要求或特定属性组合）在JSON模式中难以或冗长地表达，但在自然语言规则中对LLM来说很容易表达，并且可以与目录模式打包，以便为特定目录定制提示。

## 协议生命周期变更

### 3.1. `beginRendering` 被 `createSurface` 替代

**v0.8.1 (`beginRendering`)**：
- **显式信号**：服务器发送 `beginRendering` 消息，告诉客户端“我已经发送完初始组件批，你可以绘制了。”
- **根定义**：根组件ID在此消息中定义。
- **样式信息**：消息包含表面的样式信息。

**v0.9 (`createSurface`)**：
- **替代**：`beginRendering` 被 **`createSurface`** 替代。
- **目的**：`createSurface` 信号客户端创建一个新表面并准备渲染。
- **样式信息移除**：`createSurface` **不包含**样式信息。主题现在通过客户端样式处理，使其与消息流解耦。
- **根规则**：规则是：“必须恰好有一个ID为 `root` 的组件。” `beginRendering` 的“root”属性已被移除。客户端应在拥有有效树和根组件时立即渲染。
- **新要求**：`createSurface` 现在需要一个 **`catalogId`** (URI) 来明确说明正在使用的组件集。

**示例**：

**v0.8.1 (`beginRendering`)**:
```json
{
  "beginRendering": {
    "surfaceId": "user_profile_card",
    "root": "root",
    "styles": {
      "primaryColor": "#007bff",
    }
  }
}
```

**v0.9 (`createSurface`)**:
```json
{
  "createSurface": {
    "surfaceId": "user_profile_card",
    "catalogId": "https://a2ui.dev/specification/0.9/standard_catalog_definition.json"
  }
}
```

**Section sources**
- [evolution_guide.md](file://specification/0.9/docs/evolution_guide.md#L66-L105)
- [a2ui_protocol.md](file://specification/0.9/docs/a2ui_protocol.md#L108-L126)

## 消息结构变更

### 4.1. 组件更新

**v0.8.1 (`surfaceUpdate`)**：
- 组件被包装在一个对象中，其中 **键** 是组件类型。
- **结构**：`{ "id": "...", "component": { "Text": { "text": "..." } } }`

**v0.9 (`updateComponents`)**：
- **重命名**：`surfaceUpdate` -> `updateComponents`。
- **重构**：组件使用带有常量判别符属性 `component` 的扁平结构。
- **结构**：`{ "id": "...", "component": "Text", "text": "..." }`
- **原因**：这种带有判别符字段（`component: "Text"`）的“扁平”结构比动态键（`"Text": {...}`）更容易让LLM一致生成。它也简化了许多JSON解析器中的多态性。

#### 并排示例

**v0.8.1**:

```json
{
  "surfaceUpdate": {
    "surfaceId": "main",
    "components": [
      {
        "id": "title",
        "component": {
          "Text": { "text": { "literalString": "Hello" } }
        }
      }
    ]
  }
}
```

**v0.9**:

```json
{
  "updateComponents": {
    "surfaceId": "main",
    "components": [
      {
        "id": "root",
        "component": "Column",
        "children": ["title"]
      },
      {
        "id": "title",
        "component": "Text",
        "text": "Hello"
      }
    ]
  }
}
```

**Section sources**
- [evolution_guide.md](file://specification/0.9/docs/evolution_guide.md#L109-L165)
- [a2ui_protocol.md](file://specification/0.9/docs/a2ui_protocol.md#L128-L162)

### 4.2. 数据模型更新

**v0.8.1 (`dataModelUpdate`)**：
- **邻接表**：`contents` 属性是 **数组** 的键值对对象。
- **类型化值**：每个条目需要显式类型如 `valueString`, `valueNumber`, `valueBoolean`。
- **结构**：`[{ "key": "name", "valueString": "Alice" }]`

**v0.9 (`updateDataModel`)**：
- **重命名**：`dataModelUpdate` -> `updateDataModel`。
- **标准JSON**：`value` 属性现在是标准的 **JSON对象**。
- **Op**：添加了 `op` 属性以允许更复杂的更新（例如，`replace`, `remove`）。
- **结构**：`{ "name": "Alice" }`
- **原因**：LLM被训练生成JSON对象。强迫它们生成映射的“邻接表”表示是低效且容易出错的。

**Section sources**
- [evolution_guide.md](file://specification/0.9/docs/evolution_guide.md#L167-L182)
- [a2ui_protocol.md](file://specification/0.9/docs/a2ui_protocol.md#L164-L189)

## 数据绑定与状态管理

### 5.1. `path` 的标准化

**v0.8.1**：
- 在 `childrenProperty` 模板中使用 `dataBinding`。
- 在 `BoundValue` 对象中使用 `path`。
- 术语不一致。

**v0.9**：
- **统一**：所有内容现在都是 **`path`**。
- **原因**：减少LLM的认知负担。“Path”始终意味着“指向数据的JSON指针”。

### 5.2. 简化的绑定值

**v0.8.1**：
- `{ "literalString": "foo" }` 或 `{ "path": "/foo" }`。
- 在键中显式类型化（`literalNumber`, `literalBoolean`）。

**v0.9**：
- **隐式类型化**：`stringOrPath`, `numberOrPath` 等在 `common_types.json` 中定义。
- **结构**：模式允许 `string` 或 `{ "path": "..." }`。
- **原因**：更自然的JSON。`{ "text": "Hello" }` 是有效的。`{ "text": { "path": "/msg" } }` 是有效的。不再需要 `{ "text": { "literalString": "Hello" } }`。

**Section sources**
- [evolution_guide.md](file://specification/0.9/docs/evolution_guide.md#L184-L210)
- [standard_catalog_definition.json](file://specification/0.9/json/standard_catalog_definition.json)

## 组件变更

### 6.1. 按钮上下文

**v0.8.1**：
- **数组对**：`context: [{ "key": "id", "value": "123" }]`
- **原因**：易于解析，难以生成。

**v0.9**：
- **标准映射**：`context: { "id": "123" }`
- **原因**：令牌效率。LLM天生理解JSON对象作为映射。

### 6.2. TextField

**v0.8.1**：
- 属性：`textFieldType` (例如，"email", "password")。

**v0.9**：
- 属性：**`usageHint`**。
- **原因**：与已使用 `usageHint` 的 `Text` 和 `Image` 组件保持一致。

### 6.3. ChoicePicker (vs MultipleChoice)

**v0.8.1**：
- 组件：**`MultipleChoice`**。
- 属性：`selections` (数组), `maxAllowedSelections` (整数)。

**v0.9**：
- 组件：**`ChoicePicker`**。
- 属性：**`value`** (数组), **`usageHint`** (枚举：`multipleSelection`, `mutuallyExclusive`)。`maxAllowedSelections` 属性已被移除。
- **原因**：`ChoicePicker` 是一个更通用的名称，涵盖了单选按钮（互斥）和复选框（多选）。`usageHint` 控制行为，简化了组件表面区域。

### 6.4. Slider

**v0.8.1**：
- 属性：`minValue`, `maxValue`。

**v0.9**：
- 属性：**`min`**, **`max`**。
- **原因**：标准化为更短、更常见的属性名称。

**Section sources**
- [evolution_guide.md](file://specification/0.9/docs/evolution_guide.md#L213-L258)
- [standard_catalog_definition.json](file://specification/0.9/json/standard_catalog_definition.json)

## 错误处理

**v0.9** 引入了 `client_to_server.json` 中严格的 **`ValidationFailed`** 错误格式。

- **目的**：使“提示-生成-验证”循环能够有效工作。
- **机制**：如果LLM生成了无效的JSON，系统会发送回一个结构化错误：
  ```json
  {
    "error": {
      "code": "VALIDATION_FAILED",
      "surfaceId": "...",
      "path": "/components/0/text",
      "message": "Expected string, got number"
    }
  }
  ```
- **结果**：LLM看到此错误后，可以在下一次生成中“自我纠正”。

**Section sources**
- [evolution_guide.md](file://specification/0.9/docs/evolution_guide.md#L260-L277)
- [a2ui_protocol.md](file://specification/0.9/docs/a2ui_protocol.md#L424-L445)

## 迁移检查清单

为确保系统已完全升级到v0.9，请遵循以下检查清单：

- [ ] 将所有 `beginRendering` 消息替换为 `createSurface` 消息。
- [ ] 在 `createSurface` 消息中添加 `catalogId` 字段。
- [ ] 移除 `createSurface` 消息中的 `styles` 字段。
- [ ] 将所有 `surfaceUpdate` 消息重命名为 `updateComponents`。
- [ ] 将组件结构从 `{ "id": "...", "component": { "Text": { ... } } }` 重构为 `{ "id": "...", "component": "Text", ... }`。
- [ ] 将所有 `dataModelUpdate` 消息重命名为 `updateDataModel`。
- [ ] 将 `dataModelUpdate` 的 `contents` 数组替换为 `value` 对象。
- [ ] 将所有 `dataBinding` 和 `path` 用法统一为 `path`。
- [ ] 将 `Button` 的 `context` 数组替换为标准JSON对象。
- [ ] 将 `TextField` 的 `textFieldType` 属性替换为 `usageHint`。
- [ ] 将 `MultipleChoice` 组件替换为 `ChoicePicker` 组件。
- [ ] 将 `Slider` 的 `minValue` 和 `maxValue` 属性替换为 `min` 和 `max`。
- [ ] 实现 `ValidationFailed` 错误处理机制。
- [ ] 在系统提示中包含 `standard_catalog_rules.txt`。

**Section sources**
- [evolution_guide.md](file://specification/0.9/docs/evolution_guide.md)
- [a2ui_protocol.md](file://specification/0.9/docs/a2ui_protocol.md)

## 设计动机与未来方向

v0.9的“提示优先”方法带来了几个优势：
1.  **更丰富的模式**：协议不再受结构化输出格式的限制，允许更易读、更复杂和更具表现力的组件目录。
2.  **模块化**：模式现在被重构为更易管理的独立组件，提高了可维护性和模块化。

主要缺点是需要更复杂的生成后验证，因为LLM不受模式的严格约束。这需要强大的错误处理和纠正机制，以便系统能够识别差异并尝试在渲染前修复它们，或请求LLM重试或纠正。

未来的发展方向包括进一步优化提示和模式，以提高LLM生成UI的准确性和效率，以及扩展组件目录以支持更多交互式和动态的UI元素。

**Section sources**
- [a2ui_protocol.md](file://specification/0.9/docs/a2ui_protocol.md#L30-L40)
- [evolution_guide.md](file://specification/0.9/docs/evolution_guide.md#L1-L277)